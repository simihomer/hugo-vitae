{{- $pp := . }}
{{- $page := .Page }}
{{- $templateName := "executive" }}
{{- $template := printf "vitae/main/content/%s" $templateName }}

{{ partial "html-comment" (printf "BEGIN '%s'" $template) }}

{{- $vitaeDefaultTemplate := $pp.VitaeDefaultTemplate }}
{{- $vitaeTemplate := $pp.VitaeTemplate }}
{{- $vitaeData := $pp.VitaeData }}
{{- $vitaeStyle := $pp.VitaeStyle }}
{{- $vitaeParams := $pp.VitaeParams }}

{{- $debug := false }}
{{/* {{- $debug = or $debug (not (not (findRE `^/([^/]+-demo/)?devel` $page.RelPermalink) ) ) -}} */}}
{{/* {{- $useStyleMerged := and true $debug }} */}}
{{- $useStyleMerged := true }}
{{- $validStyles := (dict
  "ats" (dict
    "ANY_BOOL" true
  )
  "inline_separator" (dict
    "ANY_STRING" true
  )
  "role_header_separator" (dict
    "ANY_STRING" true
  )
  "stage_meta_separator" (dict
    "ANY_STRING" true
  )
  "layout" (dict
    "shallow" "shallow"
    "narrow" "narrow"
    "inline" "inline"
  )
  "display" (dict
    "grid" "grid"
  )
  "timeline" (dict
    "false" false
    "true" "column"
  )
  "heading" (dict
    "normal" "normal"
    "larger-1" "larger-1"
    "larger-2" "larger-2"
  )
  "font-size" (dict
    "normal" "normal"
    "smaller-1" "smaller-1"
    "smaller-2" "smaller-2"
  )
  "logo" (dict
    "false" false
    "true" "left"
    "left" "left"
  )
) -}}

{{- $mergedStyle := partial "vitae/_functions/style-class" (dict
  "Style" $vitaeStyle
  "ValidStyles" $validStyles
  "Template" $template
) -}}
{{- if $debug }}
  {{- warnf "%s[%s]: After style-class:\nmergedStyle=%v" $page $template
      (jsonify (dict "indent" "  ") $mergedStyle) }}
{{- end }}
{{- $style := $mergedStyle.Style }}
{{- $styleClassList := $mergedStyle.StyleClass }}

{{- $mergedStyleNew := false }}
{{- $validStylesNew := false }}

{{- if $useStyleMerged }}
  {{- $validStylesNew = (dict
    "_template" $template
    "ats" "ANY_BOOL"
    "inline_separator" "ANY_STRING"
    "role_header_separator" "ANY_STRING"
    "stage_meta_separator" "ANY_STRING"
    "layout" (slice "shallow" "narrow" "inline")
    "display" (dict
      "grid" "grid"
    )
    "timeline" (dict
      "false" false
      "true" "column"
    )
    "heading" (dict
      "normal" "normal"
      "larger-1" "larger-1"
      "larger-2" "larger-2"
    )
    "font-size" (dict
      "normal" "normal"
      "smaller-1" "smaller-1"
      "smaller-2" "smaller-2"
    )
    "logo" (dict
      "false" false
      "true" "left"
      "left" "left"
    )
  ) -}}

  {{- $mergedStyleNew = partial "vitae/_functions/style-merged" (dict
    "Style" $vitaeStyle
    "ValidStyles" $validStylesNew
    "Template" $template
  ) -}}
  {{- if $debug }}
    {{- warnf "%s[%s]: vitaeStyle=%v\nvalidStylesNew=%v\n\nAfter style-merged:\nmergedStyle=%v\nmergedStyleNew=%v" $page $template
        (jsonify (dict "indent" "  ") $vitaeStyle)
        (jsonify (dict "indent" "  ") $validStylesNew)
        (jsonify (dict "indent" "  ") $mergedStyle)
        (jsonify (dict "indent" "  ") $mergedStyleNew) -}}
    {{/* {{- warnf "%s[%s]: After style-merged:\nmergedStyle=%v\nmergedStyleNew=%v" $page $template
        (jsonify (dict "indent" "  ") (merge $mergedStyle (dict "ValidStyles" "OMITTED")))
        (jsonify (dict "indent" "  ") (merge $mergedStyleNew (dict "ValidStyles" "OMITTED"))) -}} */}}
  {{- end }}
  {{- $style = $mergedStyle.Style }}
  {{- $styleClassList = $mergedStyle.StyleClass }}
{{- end }}

{{- $slotSeparator := "section-gap_vertical" }}
{{- $sectionSeparator := $slotSeparator }}

<!-- Pagination
Part: an independent section of one or more printed pages
PaginationPage: a printed page that is part of a Part
-->

{{- /* Section params can be overriden from front matter under $vitaeSectionsRoot:
    ---
    vitae:
      sections:
        patents-publications:
          enabled: false
    ---
*/ -}}
{{- $originalParts := $vitaeTemplate.parts }}
{{- $parts := $originalParts }}
{{- with $vitaeParams.parts }}
  {{- $parts = slice }}
  {{- warnf "%s[%s]: vitaeParams.parts=%v" $page $template
      (jsonify (dict "indent" "  ") $vitaeParams.parts) }}
  {{- range $originalPart := $originalParts }}
    {{- with index $vitaeParams.parts .part }}
      {{- $part := merge $originalPart . }}
      {{- $parts = append $part $parts }}
      {{- warnf "%s[%s]: applied vitaeParams.parts.%v=%v\nto part=%v" $page $template
          $part.part (jsonify (dict "indent" "  ") . ) (jsonify (dict "indent" "  ") $part ) }}
    {{- else }}
      {{- $parts = append $originalPart $parts }}
    {{- end }}
  {{- end }}
{{- end }}

{{- range $partIndex, $part := where $parts "enabled" "ne" false }}
  <!-- Initially, all content is placed within one Pagination Page
  When rendering the print preview with `print-view.js`,
  this DOM node is cloned and the content is distributed across as many
  clones as required -->
  {{- $partClassList := append $styleClassList (slice
      (printf "template_%s" $part.template)
      (printf "%s%d" $pp.PartClassPrefix $partIndex)
      $pp.PaginationPageClass
    ) -}}

  {{- $partSlots := slice }}
  {{- range $slotIndex, $slotParams := $part.slots }}
    {{- $slot := false }}
    {{- $slotName := $slotParams.slot }}
    {{/* If the params for this slot have a key `sections`, use the sections
         listed in there as the content of the slot */}}
    {{/* {{- partial "html-comment" (printf "Slot %v\nslotParams:\n%v" $slotName (jsonify (dict "indent" "  ") $slotParams)) }} */}}
    {{- with $slotParams.sections }}
      {{- $slot = $slotParams }}
    {{- end }}
    {{/* If the params for this slot have a key `shared`, add the sections
         listed in the params being referred to */}}
    {{- with $slotParamsShared := $slotParams.shared }}
      {{- if $style.ats }}
        {{/* If we are targetting Applicant Tracking Systems (ATS),
            we do not include any shared slots such as headers or footers */}}
        {{- if $debug }}
          {{- warnf "%s[%s]: style.ats=%v: not including shared section vitaeTemplate.shared.%v"
              $page $template $style.ats $slotParamsShared }}
          {{- end }}
      {{- else }}
        {{/* Initialize the slot with the default variant of the template */}}
        {{- with index $vitaeDefaultTemplate.shared $slotParamsShared }}
          {{- $slot = merge $slotParams . }}
          {{- if $debug }}
            {{/* {{- partial "html-comment" (printf "<h2>vitaeDefaultTemplate.shared.%s</h2><pre>%v</pre>"
                $slotParamsShared (jsonify (dict "indent" "  ") .)) }}
            {{- partial "html-comment" (printf "<h2>slot after merging vitaeDefaultTemplate.shared.%s</h2><pre>%v</pre>"
                $slotParamsShared (jsonify (dict "indent" "  ") $slot)) }} */}}
            {{- warnf "%s[%s]: slot=%v including vitaeDefaultTemplate.shared.%v=%v"
                $page $template (jsonify (dict "indent" "  ") $slot)
                $slotParamsShared
                (jsonify (dict "indent" "  ") $vitaeDefaultTemplate.shared) }}
          {{- end }}
        {{- end }}
        {{- with index $vitaeTemplate.shared $slotParamsShared }}
          {{- $slot = merge $slotParams . }}
          {{- if $debug }}
            {{/* {{- partial "html-comment" (printf "slot after merging vitaeTemplate.shared.%s\n%v"
                $slotParamsShared (jsonify (dict "indent" "  ") $slot)) }} */}}
            {{- warnf "%s[%s]: vitaeTemplate.shared.%v=%v" $page $template $slotParamsShared $vitaeTemplate.shared }}
          {{- end }}
        {{- end }}
        {{- if not $slot }}
          {{- errorf "%s[%s]: shared template not found for vitaeTemplate.shared.%v=%v" $page $template $slotParamsShared $vitaeTemplate.shared }}
        {{- end }}
      {{- end }}
    {{- end }}

    {{- with $slot }}
      {{- with $slot.pagination_container_class }}
        {{- $partClassList = append . $partClassList }}
      {{- end }}
      {{- $slot = merge $slot (dict "slot" $slotName) }}
      {{- $partSlots = append $slot $partSlots }}
    {{- end }}
  {{- end }}

  <div class="{{ delimit $partClassList ` `}}">
    {{- range $slotIndex, $slot := $partSlots }}
      {{/* {{ partial "html-comment" (printf "[%s]: slot[%T] name=%s:\n%v"
          $template $slot $slot.slot (jsonify (dict "indent" "  ") $slot) ) }} */}}
      {{/* {{- warnf "%s[%s]: slot=%v" $page $template $slot.slot }} */}}
      {{/* {{- warnf "%s[%s]: shared=%v" $page $template $slot.shared }} */}}
      {{- $paginationPolicy := $slot.pagination_policy | default $part.pagination_policy | default `break` }}
      {{- $paginationOrder := $slot.pagination_order | default $slotIndex }}
      {{- $container := default "div" .container }}
      {{- with $slotSeparator }}
        {{- if gt $slotIndex 0 }}
          <div class="{{ . }}"></div>
        {{- end }}
      {{- end }}
      {{- with $container }}
        {{- $containerClass := slice (printf "slot_%s slot" $slot.slot) $pp.PaginationContainerClass }}
        {{- with $slot.container_class }}
          {{- $containerClass = append . $containerClass }}
        {{- end }}

        {{- $mergedSlotStyle := false }}
        {{- with $slotStyle := $slot.style }}
          {{- $mergedSlotStyle = partial "vitae/_functions/style-class" (dict
            "Style" $slotStyle
            "ValidStyles" $validStyles
            "Template" $template
          ) -}}
          {{- if $debug }}
            {{- warnf "%s[%s]: After style-class:\nmergedSlotStyle=%v" $page $template
                (jsonify (dict "indent" "  ") $mergedSlotStyle) }}
          {{- end }}

          {{- $mergedSlotStyleNew := false }}
          {{- if $useStyleMerged }}
            {{- $mergedSlotStyleNew = partial "vitae/_functions/style-merged" (dict
              "Style" $slotStyle
              "ValidStyles" $validStylesNew
              "Template" $template
            ) -}}
            {{- if $debug }}
              {{- warnf "%s[%s]: slotStyle=%v\nvalidStylesNew=%v\n\nAfter style-merged:\nmergedSlotStyle=%v\nmergedSlotStyleNew=%v" $page $template
                  (jsonify (dict "indent" "  ") $slotStyle)
                  (jsonify (dict "indent" "  ") $validStylesNew)
                  (jsonify (dict "indent" "  ") $mergedSlotStyle)
                  (jsonify (dict "indent" "  ") $mergedSlotStyleNew) -}}
            {{- end }}
            {{- $mergedSlotStyle = $mergedSlotStyleNew }}
          {{- end }}

          {{- with $mergedSlotStyle.StyleClass }}
            {{- $containerClass = append . $containerClass }}
          {{- end }}
        {{- end }}
        {{ printf `<%s class="%s" %s="%d" %s="%s">` $container
        (delimit $containerClass ` `)
        $pp.PaginationOrderAttr $paginationOrder
        $pp.PaginationPolicyAttr $paginationPolicy | safeHTML }}
      {{- end }}
      {{- $childClass := default "" .child_class }}

      {{- /* Section params can be overriden from front matter under $vitaeSectionsRoot:
          ---
          vitae:
            sections:
              patents-publications:
                enabled: false
          ---
      */ -}}
      {{- $originalSections := $slot.sections }}
      {{- $sections := $originalSections }}
      {{- with $vitaeParams.sections }}
        {{- $sections = slice }}
        {{- warnf "%s[%s]: vitaeParams.sections=%v" $page $template
            (jsonify (dict "indent" "  ") $vitaeParams.sections) }}
        {{- range $originalSection := $slot.sections }}
          {{- with index $vitaeParams.sections .section }}
            {{- $section := merge $originalSection . }}
            {{- $sections = append $section $sections }}
            {{- warnf "%s[%s]: applied vitaeParams.sections.%v=%v\nto section=%v" $page $template
                $section.section (jsonify (dict "indent" "  ") . ) (jsonify (dict "indent" "  ") $section ) }}
          {{- else }}
            {{- $sections = append $originalSection $sections }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- partial "vitae/_components/index" (merge $pp (dict
        "Page" $page
        "Template" $vitaeTemplate
        "MergedStyle" $mergedStyle
        "MergedStyleNew" $mergedStyleNew
        "ChildClass" $childClass
        "Data" $vitaeData
        "Sections" $sections
        "SectionSeparator" $sectionSeparator
      )) -}}
      {{- with $container }}
        {{ printf `</%s>` . | safeHTML }}
      {{- end }}
    {{- end }}
  </div>
{{- end }}
{{ partial "html-comment" (printf "END   '%s'" $template) }}
