{{- $template := "vitae/_functions/style-merged" }}
{{- $mergedStyle := false }}
{{- $callingTemplate := .Template }}

{{- $style := dict }}
{{- $validStyles := dict }}

{{- $resultStyle := dict }}
{{- $styleClass := slice }}

{{- with .MergedStyle }}
  {{- with .Style }}
    {{- $style = merge $style . }}
  {{- end }}
  {{- with .ValidStyles }}
    {{- $validStyles = merge $validStyles . }}
  {{- end }}
{{- end }}
{{- with .Style }}
  {{- $style = merge $style . }}
{{- end }}
{{- with .ValidStyles }}
  {{- $validStyles = merge $validStyles . }}
{{- end }}
{{- $stylePath := default slice .StylePath }}
{{- $inducedPath := default slice .InducedPath }}

{{- $debug := false }}
{{/* {{- $debug = or $debug (and (strings.HasSuffix $callingTemplate "executive") (not (not (findRE `^/([^/]+-demo/)?devel/$` page.RelPermalink) ) ) ) -}} */}}
{{/* {{- $debug = or $debug (and (strings.HasSuffix $callingTemplate "_components/index") (not (not (findRE `^/([^/]+-demo/)?devel/$` page.RelPermalink) ) ) ) -}} */}}
{{- $debug = or $debug (and (strings.HasSuffix $callingTemplate "_components/skills") (not (not (findRE `^/([^/]+-demo/)?devel/$` page.RelPermalink) ) ) ) -}}
{{- $warnPrefix := printf "%s[%s->%s]: " page $callingTemplate $template }}
{{- $debugPrefix := $warnPrefix }}
{{- $debugPrefix = $template }}
{{- with printf "%v%v%v"
    (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
    (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
    (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
  {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
{{- else }}
  {{- $debugPrefix = printf "%v: " $debugPrefix }}
{{- end }}

{{- if $debug }}
  {{- warnf "%vstyle-merged called with style=%v\nvalidStyles=%v" $debugPrefix
      (jsonify (dict "indent" "  ") $style)
      (jsonify (dict "indent" "  ") $validStyles) }}
{{- end }}

{{/* validationType:
     `valid_types`: acceptable native type of Hugo
         This allows validating params that may have arbitrary values, such as strings,
         or whose value is within a small set, such as bool
     `class`: how the value is turned into a CSS class value (if at all)
*/}}

{{- $validationType := (dict
  "ANY_BOOL" (dict
    "valid_types" (slice "bool")
    "class" "boolean"
  )
  "ANY_STRING" (dict
    "valid_types" (slice "string" "int")
    "class" "ignore"
  )
  "ANY_INT" (dict
    "valid_types" (slice "int")
    "class" "value"
  )
) }}

{{- $mergeInducingParamValue := false }}

{{- with $style }}

  {{- range $key, $value := . }}

    {{/* We accept multiple values if and only if validValuesForKey is a slice */}}
    {{- $returnSlice := false }}

    {{/* {{- $resultingValueType := cond (reflect.IsSlice $validValuesForKey) "SLICE" "SCALAR" }} */}}

    {{- $resultingValueList := slice }}

    {{- $validValuesForKey := index $validStyles $key }}
    {{- if ne (printf "%T" $validValuesForKey) "<nil>" }}

      {{/* If the value is a map, it applies to params nested deeper
           and we call this template recursively to handle this.
           We then merge the result at the right level to $style */}}
      {{- if reflect.IsMap $value }}

        {{- $subParams := (dict
          "Template" $callingTemplate
          "Style" $value
          "ValidStyles" $validValuesForKey
          "StylePath" (append $key $stylePath)
          "InducedPath" $inducedPath
          "Debug" $debug
        ) }}

        {{- if $debug }}
          {{- warnf "%vkey=%v: value is map=%v\nRecursive call with style=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") $value)
              (jsonify (dict "indent" "  ") $subParams.Style) }}
        {{- end }}

        {{- with $mergedStyleSub := partial $template $subParams }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: recursive call with subParams=%v\nreturned mergedStyleSub=%v"
                $debugPrefix $key (jsonify (dict "indent" "  ") ($subParams))
                (jsonify (dict "indent" "  ") $mergedStyleSub) }}
          {{- end }}
          {{- $mergeParams := (dict
            "Template" $template
            "Style" (index $resultStyle $key)
            "ValidStyles" $validValuesForKey
            "AddStyle" $mergedStyleSub.Style
            "StylePath" (append $key $stylePath)
            "Debug" $debug
          ) }}
          {{- $subResultStyle := partial "merge_deep" $mergeParams }}
          {{- $resultStyle = merge $resultStyle (dict $key $subResultStyle) }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: merge_deep call with mergeParams=%v\nreturned subResultStyle=%v\nresultStyle=%v"
                $debugPrefix $key (jsonify (dict "indent" "  ") ($mergeParams))
                (jsonify (dict "indent" "  ") $subResultStyle)
                (jsonify (dict "indent" "  ") $resultStyle) }}
          {{- end }}
        {{- end }}

      {{- else }}

        {{- $returnSlice = reflect.IsSlice $validValuesForKey }}
        {{- if reflect.IsSlice $value }}
          {{- if $returnSlice }}
            {{- range $value }}
              {{/* FIXME: Should we not be using the context (.) instead of $value? */}}
              {{- $resultingValueListParams := (dict
                "Template" $template
                "ValidStyles" $validStyles
                "Key" $key
                "Value" $value
                "StylePath" $stylePath
                "InducedPath" $inducedPath
                "Debug" $debug
              ) }}
              {{- $resultingValueListSub := partial "resulting_value_list" $resultingValueListParams }}
              {{- $resultingValueList = append $resultingValueListSub $resultingValueList }}
              {{- if $debug }}
                {{- warnf "%vkey=%v: call to resulting_value_list returned resultingValueListSub=%v"
                    $debugPrefix $key (jsonify (dict "indent" "  ") $resultingValueListSub) }}
              {{- end }}
            {{- end }}
          {{- else }}
            {{- errorf "%vInvalid value=%v [type=%T]: must not be slice as returnSlice=%v == (reflect.IsSlice validValuesForKey)=%v [type=%T] with validValuesForKey=%v"
                $debugPrefix $value $value $returnSlice (reflect.IsSlice $validValuesForKey) $validValuesForKey (jsonify (dict "indent" "  ") $validValuesForKey) }}
          {{- end }}

        {{- else }}
          {{- $resultingValueListParams := (dict
            "Template" $template
            "ValidStyles" $validStyles
            "Key" $key
            "Value" $value
            "StylePath" $stylePath
            "InducedPath" $inducedPath
            "Debug" $debug
          ) }}
          {{- $resultingValueListSub := partial "resulting_value_list" $resultingValueListParams }}
          {{- $resultingValueList = append $resultingValueListSub $resultingValueList }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: call to resulting_value_list returned resultingValueListSub=%v"
                $debugPrefix $key (jsonify (dict "indent" "  ") $resultingValueListSub) }}
          {{- end }}
        {{- end }}

      {{- end }}

      {{- range $valueToResultingValue := $resultingValueList }}

        {{- if $debug }}
          {{- warnf "%vkey=%v: value=%v [type=%T] returnSlice=%v: process valueToResultingValue=%v"
              $debugPrefix $key $value $value $returnSlice
              (jsonify (dict "indent" "  ") $valueToResultingValue) }}
        {{- end }}

        {{- $paramValue := $valueToResultingValue.ParamValue }}
        {{- $resultingValue := $valueToResultingValue.ResultingValue }}

        {{- $addStyle := dict }}

        {{- if reflect.IsMap $resultingValue }}
          {{- if (gt (len $inducedPath) 5 ) }}
            {{- errorf "%vkey=%v: aborting induced call chain at inducedPath=%v"
                  $warnPrefix $key $inducedPath }}
          {{- else }}
            {{/* As the resultingValue is a map means, we treat the resultingValue
                as if it had been passed as $style:
                We call $template with Style = resultingValue
                But we still use ValidStyles = validStyles because the
                resultingValue applies to the top-level validStyles */}}
            {{- $subValidStyles := index $validStyles $key }}
            {{- if ne (printf "%T" $subValidStyles) "<nil>" }}
              {{- $subParams := (dict
                "Template" $callingTemplate
                "Style" $resultingValue
                "ValidStyles" $validStyles
                "StylePath" $stylePath
                "InducedPath" (append $key $inducedPath)
                "Debug" $debug
              ) }}
              {{- if $debug }}
                {{- warnf "%vkey=%v: resultingValue is MAP=%v\nInduced call with subParams=%v"
                    $debugPrefix $key
                    (jsonify (dict "indent" "  ") $resultingValue)
                    (jsonify (dict "indent" "  ") $subParams) }}
              {{- end }}
              {{- with $mergedStyleSub := partial $template $subParams }}

                {{- if $mergeInducingParamValue }}
                  {{- $addStyle = merge $paramValue $mergedStyleSub.Style }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v: addStyle=%v\nincluding paramValue=%v\nand result of induced call: mergedStyleSub=%v"
                        $debugPrefix $key (jsonify (dict "indent" "  ") $addStyle)
                        (jsonify (dict "indent" "  ") $paramValue)
                        (jsonify (dict "indent" "  ") $mergedStyleSub) }}
                  {{- end }}
                {{- else }}
                  {{- $addStyle = $mergedStyleSub.Style }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v: addStyle=%v\nnot including paramValue=%v\nbut result of induced call: mergedStyleSub=%v"
                        $debugPrefix $key (jsonify (dict "indent" "  ") $addStyle)
                        (jsonify (dict "indent" "  ") $paramValue)
                        (jsonify (dict "indent" "  ") $mergedStyleSub) }}
                  {{- end }}
                {{- end }}

              {{- else }}
                {{- errorf "%vkey=%v: induced call returned invalid mergedStyleSub=%v"
                    $debugPrefix $key (jsonify (dict "indent" "  ") $mergedStyleSub) }}
              {{- end }}
            {{- else }}
              {{- errorf "%vkey=%v: cannot make induced call with resultingValue=%v as key=%v yielded subValidStyles=%v"
                  $debugPrefix $resultingValue $key (jsonify (dict "indent" "  ") $resultingValue)
                  $key $subValidStyles }}
            {{- end }}
          {{- end }}

        {{- else }}

          {{- if $returnSlice }}
            {{- if $debug }}
              {{- warnf "%vkey=%v: turn resultingValue %v into a slice as value is a slice=%v [type=%T]"
                  $debugPrefix $key $resultingValue $value $value }}
            {{- end }}
            {{- $resultingValue = slice $resultingValue }}
          {{- end }}

          {{- $addStyle = (dict $key $resultingValue) }}

        {{- end }}

        {{/* {{- $mergeParams := (dict
          "Template" $template
          "Style" $resultStyle
          "ValidStyles" $validStyles
          "AddStyle" $addStyle
          "StylePath" slice
          "Debug" $debug
        ) }}
        {{- $resultStyle = partial "merge_deep" $mergeParams }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: merge_deep call returned resultStyle=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") $resultStyle) }}
        {{- end }} */}}

        {{- $mergeParams := (dict
          "Template" $template
          "Style" $resultStyle
          "ValidStyles" $validStyles
          "AddStyle" $addStyle
          "StylePath" $stylePath
          "Debug" $debug
        ) }}
        {{- $subResultStyle := partial "merge_deep" $mergeParams }}
        {{- $resultStyle = merge $resultStyle $subResultStyle }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: merge_deep call with mergeParams=%v\nreturned subResultStyle=%v\nresultStyle=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") ($mergeParams))
              (jsonify (dict "indent" "  ") $subResultStyle)
              (jsonify (dict "indent" "  ") $resultStyle) }}
        {{- end }}

      {{- end }}

    {{- else }}

      {{- warnf `%vInvalid style key='%v' with value=%v`
        $warnPrefix $key
        (jsonify (dict "indent" "  ") $value) }}

    {{- end }}

  {{- end }}

  {{- if and (eq (len $stylePath) 0) (eq (len $inducedPath) 0) }}
    {{- $styleClassParams := (dict
      "Template" $template
      "Style" $resultStyle
      "ValidStyles" $validStyles
      "ValidationType" $validationType
      "Debug" $debug
    ) }}
    {{- $styleClass = partial "style_class" $styleClassParams }}
  {{- end }}

{{- end }}

{{- $mergedStyle = (dict
  "Style" (merge $style $resultStyle)
  "ValidStyles" $validStyles
  "StyleClass" $styleClass
) -}}

{{- if and $styleClass $debug }}
  {{- warnf "%vEnd of style-merged: Returning mergedStyle=%v" $debugPrefix
      (jsonify (dict "indent" "  ") $mergedStyle) }}
{{- end }}

{{- return $mergedStyle }}

{{- /* ***************************************************************** */ -}}

{{- define "partials/resulting_value_list.html" }}
  {{- $template := "resulting_value_list" }}
  {{- $callingTemplate := .Template }}
  {{- $key := .Key }}
  {{- $value := .Value }}
  {{- $validStyles := .ValidStyles }}
  {{- $stylePath := default slice .StylePath }}
  {{- $inducedPath := default slice .InducedPath }}

  {{- $debug := false }}
  {{- $debug = or $debug .Debug }}

  {{- $warnPrefix := printf "%s[%s->%s]: " page $callingTemplate $template }}
  {{- $debugPrefix := $warnPrefix }}
  {{- with printf "%v%v%v"
      (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
      (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
      (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
    {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
  {{- else }}
    {{- $debugPrefix = printf "%v: " $debugPrefix }}
  {{- end }}

  {{- $resultingValueList := slice }}
  {{- $validValuesForKey := index $validStyles $key }}
  {{- if $debug }}
    {{- warnf "%vresulting_value_list called with value=%v\n with validValuesForKey=%v"
        $debugPrefix (jsonify (dict "indent" "  ") $value)
        (jsonify (dict "indent" "  ") $validValuesForKey) }}
  {{- end }}

  {{- $returnSlice := reflect.IsSlice $validValuesForKey }}

  {{- if reflect.IsMap $value }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: determine resultingValue from MAP based on entry for value=%v in validValuesForKey=%v"
          $debugPrefix $key $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}

    {{- range $innerKey, $innerValue := $value }}

      {{- if $debug }}
        {{- warnf "%vkey=%v: looking for innerKey=%v in validValuesForKey=%v"
            $debugPrefix $key $innerKey
            (jsonify (dict "indent" "  ") $validValuesForKey) }}
      {{- end }}

      {{- $resultingValue := index $validValuesForKey (string $innerKey) }}
      {{- if ne (printf "%T" $resultingValue) "<nil>" }}
        {{- if and $returnSlice (not reflect.IsSlice $resultingValue) }}
          {{- $resultingValue = slice $resultingValue }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: wrapped resultingValue in slice=%v based on entry for innerKey=%v in validValuesForKey=%v"
                $debugPrefix $key $innerKey (jsonify (dict "indent" "  ") $validValuesForKey) }}
          {{- end }}
        {{- end }}
        {{/* {{- $resultingValueList = append $resultingValue $resultingValueList }} */}}
        {{/* {{- $resultingValueParams := (dict
          "Template" $template
          "ValidStyles" $validStyles
          "ValidValuesForKey" $validValuesForKey
          "Key" $key
          "Value" $resultingValue
          "StylePath" $stylePath
          "InducedPath" $inducedPath
          "Debug" $debug
        ) }}
        {{- $resultingValueListSub := partial "resulting_value" $resultingValueParams }}
        {{- $resultingValueList = append $resultingValueListSub $resultingValueList }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: call with resultingValueParams=%v\nreturned resultingValueListSub=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") ($resultingValueParams))
              (jsonify (dict "indent" "  ") $resultingValueListSub) }}
        {{- end }} */}}
        {{- $resultingValueList = append (dict "ParamValue" $innerValue "ResultingValue" $resultingValue) $resultingValueList }}
      {{- else }}
        {{- errorf "%vInvalid value=%v [type=%v]: innerKey=%v not found in validValuesForKey=%v"
            $debugPrefix $value $value $innerKey
            (jsonify (dict "indent" "  ") $validValuesForKey) }}
      {{- end }}
    {{- end }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: resultingValueList=%v from MAP value=%v [type=%T]"
          $debugPrefix $key $resultingValueList $value $value }}
    {{- end }}

  {{- else if reflect.IsSlice $value }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: determine resultingValue from SLICE based on entry for value=%v in validValuesForKey=%v"
          $debugPrefix $key $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}

    {{/* We accept all values in the intersection between value and validValuesForKey
          but since the values may be maps, we need to use a loop */}}
    {{- range $innerValue := $value }}
      {{- $resultingValueParams := (dict
        "Template" $template
        "ValidStyles" $validStyles
        "ValidValuesForKey" $validValuesForKey
        "Key" $key
        "Value" $innerValue
        "StylePath" $stylePath
        "InducedPath" $inducedPath
        "Debug" $debug
      ) }}
      {{- $resultingValueListSub := partial "resulting_value" $resultingValueParams }}
      {{- $resultingValueList = append $resultingValueListSub $resultingValueList }}
      {{- if $debug }}
        {{- warnf "%vkey=%v: call with resultingValueParams=%v\nreturned resultingValueListSub=%v"
            $debugPrefix $key (jsonify (dict "indent" "  ") ($resultingValueParams))
            (jsonify (dict "indent" "  ") $resultingValueListSub) }}
      {{- end }}
    {{- end }}
    {{- if $debug }}
      {{- warnf "%vkey=%v: resultingValueList=%v from SLICE value=%v [type=%T]"
          $debugPrefix $key $resultingValueList $value $value }}
    {{- end }}

  {{- else }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: determine resultingValue from SCALAR based on entry for value=%v in validValuesForKey=%v"
          $debugPrefix $key $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}

    {{- $resultingValueParams := (dict
      "Template" $template
      "ValidStyles" $validStyles
      "ValidValuesForKey" $validValuesForKey
      "Key" $key
      "Value" $value
      "StylePath" $stylePath
      "InducedPath" $inducedPath
      "Debug" $debug
    ) }}
    {{- $resultingValueListSub := partial "resulting_value" $resultingValueParams }}
    {{- $resultingValueList = append $resultingValueListSub $resultingValueList }}
    {{- if $debug }}
      {{- warnf "%vkey=%v: call with resultingValueParams=%v\nreturned resultingValueListSub=%v"
          $debugPrefix $key (jsonify (dict "indent" "  ") ($resultingValueParams))
          (jsonify (dict "indent" "  ") $resultingValueListSub) }}
    {{- end }}

    {{- if $debug }}
      {{- warnf "%vkey=%v: resultingValueList=%v from SCALAR value=%v [type=%T]"
          $debugPrefix $key $resultingValueList $value $value }}
    {{- end }}

  {{- end }}

  {{- if $debug }}
    {{- warnf "%vReturning resultingValueList=%v"
      $debugPrefix
      (jsonify (dict "indent" "  ") $resultingValueList) }}
  {{- end }}

  {{- return $resultingValueList }}

{{- end }}

{{- define "partials/resulting_value.html" }}
  {{- $template := "resulting_value" }}
  {{- $callingTemplate := .Template }}
  {{- $key := .Key }}
  {{- $value := .Value }}
  {{- $validValuesForKey := .ValidValuesForKey }}
  {{- $stylePath := default slice .StylePath }}
  {{- $inducedPath := default slice .InducedPath }}

  {{- $debug := false }}
  {{- $debug = or $debug .Debug }}

  {{- $warnPrefix := printf "%s[%s->%s]: " page $callingTemplate $template }}
  {{- $debugPrefix := $warnPrefix }}
  {{- with printf "%v%v%v"
      (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
      (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
      (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
    {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
  {{- else }}
    {{- $debugPrefix = printf "%v: " $debugPrefix }}
  {{- end }}

  {{- if $debug }}
    {{- warnf "%vresulting_value called with value=%v\n with validValuesForKey=%v"
        $debugPrefix (jsonify (dict "indent" "  ") $value)
        (jsonify (dict "indent" "  ") $validValuesForKey) }}
  {{- end }}

  {{- $resultingValue := $value }}
  {{- $returnSlice := reflect.IsSlice $validValuesForKey }}

  {{- if reflect.IsMap $validValuesForKey }}
    {{- $resultingValue = index $validValuesForKey (string $value) }}
    {{- if $debug }}
      {{- warnf "%vvalidValuesForKey is MAP: resultingValue=%v == entry of value=%v in validValuesForKey=%v"
          $debugPrefix $resultingValue $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
    {{- end }}
  {{- else if reflect.IsSlice $validValuesForKey }}
    {{/* Every entry in the slice $validValuesForKey can be either
          1.  A scalar value, e.g. "inline"
          2.  A map with exactly one key, e.g. (dict "inline" (dict "inline" (slice "header" "content") )
          Anything else, i.e., a slice, is invalid */}}
    {{- $resultingValue = slice }}
    {{- range $candValue := $validValuesForKey }}
      {{- if reflect.IsMap $candValue }}
        {{- $valueAdded := false }}
        {{- range $innerKey, $innerValue := $candValue }}
          {{- if not $valueAdded }}
            {{- if eq $innerKey $value }}
              {{- if $debug }}
                {{- warnf "%vAppend innerValue=%v with innerKey=%v == value=%v to $resultingValue=%v"
                    $debugPrefix $value $innerValue $innerKey $resultingValue }}
              {{- end }}
              {{- $valueAdded = true }}
              {{- $resultingValue = append $innerValue $resultingValue }}
            {{- else }}
              {{- if $debug }}
                {{- warnf "%vDo not append innerValue=%v != value=%v to $resultingValue=%v"
                    $debugPrefix $value $innerValue $resultingValue }}
              {{- end }}
            {{- end }}
          {{- else }}
            {{- errorf "%vInvalid value=%v [type=%v]: must be a scalar or a map with exactly one key given validValuesForKey=%v"
                $debugPrefix $value $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
          {{- end }}
        {{- end }}
      {{- else if reflect.IsSlice $candValue }}
        {{- errorf "%vInvalid value=%v [type=%v]: must not be a slice given validValuesForKey=%v"
            $debugPrefix $value $value (jsonify (dict "indent" "  ") $validValuesForKey) }}
      {{- else }}
        {{- if eq $candValue $value }}
          {{- if $debug }}
            {{- warnf "%vAppend candValue=%v == value=%v to $resultingValue=%v"
                $debugPrefix $value $candValue $resultingValue }}
          {{- end }}
          {{- $resultingValue = append $candValue $resultingValue }}
        {{- end }}
      {{- end }}
    {{- end }}
  {{- end }}

  {{- $valueToResultingValue := (dict
    "ParamValue" $value
    "ResultingValue" $resultingValue
  ) }}

  {{- if $debug }}
      {{- warnf "%vReturning valueToResultingValue=%v"
        $debugPrefix
        (jsonify (dict "indent" "  ") $valueToResultingValue) }}
    {{- end }}

  {{- return $valueToResultingValue }}

{{- end }}

{{- /* ***************************************************************** */ -}}

{{- define "partials/merge_deep.html" }}
  {{- $template := "merge_deep" }}
  {{- $callingTemplate := .Template }}
  {{- $style := .Style }}
  {{- $validStyles := .ValidStyles }}
  {{- $addStyle := .AddStyle }}
  {{- $stylePath := default slice .StylePath }}
  {{- $inducedPath := default slice .InducedPath }}

  {{- $debug := false }}
  {{- $debug = or $debug .Debug }}

  {{- $warnPrefix := printf "%s[%s->%s]: " page $callingTemplate $template }}
  {{- $debugPrefix := $warnPrefix }}
  {{- with printf "%v%v%v"
      (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
      (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
      (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
    {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
  {{- else }}
    {{- $debugPrefix = printf "%v: " $debugPrefix }}
  {{- end }}

  {{- if $debug }}
    {{- warnf "%vmerge_deep called with addStyle=%v\nto style=%v\nwith validStyles=%v"
        $debugPrefix (jsonify (dict "indent" "  ") $addStyle)
        (jsonify (dict "indent" "  ") $style) (jsonify (dict "indent" "  ") $validStyles) }}
  {{- end }}

  {{- $resultStyle := $style }}

  {{- range $key, $value := $addStyle }}
    {{- if reflect.IsMap $value }}
      {{- $subStyle := default dict (index $style $key) }}
      {{- $subValidStyles := index $validStyles $key }}
      {{- $subParams := (dict
        "Template" $template
        "Style" $subStyle
        "ValidStyles" $subValidStyles
        "AddStyle"  $value
        "StylePath" $stylePath
        "InducedPath" $inducedPath
        "Debug" $debug
      ) }}
      {{- if $debug }}
        {{- warnf "%vkey=%v: value is a map: recursive call with subParams=%v"
            $debugPrefix $key
            (jsonify (dict "indent" "  ") ($subParams)) }}
      {{- end }}

      {{- with $mergedStyleSub := partial $template $subParams }}
        {{- $resultStyle = merge $resultStyle (dict $key $mergedStyleSub) }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: recursive call with subParams=%v\nmerged to resultStyle=%v"
              $debugPrefix $key
              (jsonify (dict "indent" "  ") ($subParams))
              (jsonify (dict "indent" "  ") $resultStyle) }}
        {{- end }}
      {{- end }}

    {{- else }}

      {{/* If the value in the base map, i.e., $style, for this key is a slice,
           we add the value from the update map, i.e., $addStyle, to the slice.
           Otherwise, we overwrite the value
      */}}

      {{- $validValuesForKey := index $validStyles $key }}
      {{/* {{- $keyStylePath := append $key $stylePath }}
      {{- $validValuesForKey := index $validStyles $keyStylePath }} */}}
      {{- if ne (printf "%T" $validValuesForKey) "<nil>" }}
        {{- $returnSlice := reflect.IsSlice $validValuesForKey }}
        {{- $baseValue := index $style $key }}
        {{- if ne (printf "%T" $baseValue) "<nil>" }}

          {{- if reflect.IsMap $baseValue }}
            {{- errorf "%vkey=%v: validValuesForKey=%v: invalid baseValue=%v in style=%v"
                $debugPrefix $key $validValuesForKey $baseValue
                (jsonify (dict "indent" "  ") $style) }}

          {{- else if reflect.IsSlice $baseValue }}

            {{/* Given that the base value is a slice, we assume that
                  a SCLICE is expected to be returned */}}

            {{- if not $returnSlice }}
              {{- errorf "%vkey=%v: validValuesForKey=%v is not a slice, hence baseValue=%v must not be a slice either in style=%v"
                  $debugPrefix $key $validValuesForKey $baseValue
                  (jsonify (dict "indent" "  ") $style) }}
            {{- end  }}

            {{/* Append value to baseValue */}}
            {{- $valueList := $value }}
            {{- if not (reflect.IsSlice $valueList) }}
              {{- $valueList = slice $value }}
            {{- end }}
            {{- if and false $debug }}
              {{- warnf "%vkey=%v: union valueList=%v[%T] to baseValue=%v[%T] in resultStyle=%v"
                  $debugPrefix $key $valueList $valueList $baseValue $baseValue
                  (jsonify (dict "indent" "  ") $resultStyle) }}
            {{- end }}
            {{- $resultStyle = merge $resultStyle (dict $key (union $valueList $baseValue)) }}
            {{- if $debug }}
              {{- warnf "%vkey=%v: added valueList=%v to baseValue=%v in resultStyle=%v"
                  $debugPrefix $key $valueList $baseValue
                  (jsonify (dict "indent" "  ") $resultStyle) }}
            {{- end }}

          {{- else }}

            {{/* Given that the base value is a scalar, we assume that
                  a SCALAR is expected to be returned */}}

            {{/* validValuesForKey requires a scalar */}}
            {{- if reflect.IsSlice $value }}
              {{- $value = index $value 0 }}
            {{- end }}

            {{/* Overwrite baseValue with value */}}
            {{- $resultStyle = merge $resultStyle (dict $key $value) }}

            {{- if $debug }}
              {{- warnf "%vkey=%v: validValuesForKey=%v: baseValue=%v overwritten by value=%v in resultStyle=%v"
                  $debugPrefix $key $validValuesForKey $baseValue $value
                  (jsonify (dict "indent" "  ") $resultStyle) }}
            {{- end }}

          {{- end }}

        {{- else }}

          {{/* Add value */}}

          {{- if reflect.IsSlice $value }}

            {{- if not $returnSlice }}
              {{- errorf "%vkey=%v: validValuesForKey=%v is not a slice, hence value=%v must not be a slice either in addStyle=%v"
                  $debugPrefix $key $validValuesForKey $value
                  (jsonify (dict "indent" "  ") $addStyle) }}
            {{- end  }}

          {{- else }}

            {{- if $returnSlice }}
              {{- errorf "%vkey=%v: validValuesForKey=%v is a slice, hence value=%v must be a slice as well in addStyle=%v"
                  $debugPrefix $key $validValuesForKey $value
                  (jsonify (dict "indent" "  ") $addStyle) }}
            {{- end  }}

          {{- end }}

          {{- $resultStyle = merge $resultStyle (dict $key $value) }}
          {{- if $debug }}
            {{- warnf "%vkey=%v: added value=%v to resultStyle=%v"
                $debugPrefix $key $value
                (jsonify (dict "indent" "  ") $resultStyle) }}
          {{- end }}

        {{- end }}

      {{- else }}

        {{- errorf "%vkey=%v: no entry found for key=%v in validStyles=%v"
            $debugPrefix $key $key
            (jsonify (dict "indent" "  ") $validStyles) }}

      {{- end }}

    {{- end }}
  {{- end }}

  {{- if $debug }}
    {{- warnf "%vReturning resultStyle=%v"
        $debugPrefix
        (jsonify (dict "indent" "  ") $resultStyle) }}
  {{- end }}
  {{- return $resultStyle }}
{{- end }}

{{- /* ***************************************************************** */ -}}

{{- define "partials/style_class" }}
  {{- $template := "style_class" }}
  {{- $callingTemplate := .Template }}
  {{- $style := .Style }}
  {{- $validStyles := .ValidStyles }}
  {{- $stylePath := default slice .StylePath }}
  {{- $inducedPath := default slice .InducedPath }}

  {{- $styleClassPrefix := default "style_" .StyleClassPrefix }}
  {{- $validationType := .ValidationType }}

  {{- $debug := false }}
  {{- $debug = or $debug .Debug }}

  {{- $warnPrefix := printf "%s[%s->%s]: " page $callingTemplate $template }}
  {{- $debugPrefix := $warnPrefix }}
  {{- with printf "%v%v%v"
      (cond (gt (len $stylePath) 0) (printf "stylePath=%v" $stylePath) "")
      (cond (and (gt (len $stylePath) 0) (gt (len $inducedPath) 0)) " | " "")
      (cond (gt (len $inducedPath) 0) (printf "inducedPath=%v" $inducedPath) "") }}
    {{- $debugPrefix = printf "%v %v: " $debugPrefix . }}
  {{- else }}
    {{- $debugPrefix = printf "%v: " $debugPrefix }}
  {{- end }}

  {{- if $debug }}
    {{- warnf "%vstyle_class called with style=%v\nvalidStyles=%v\nvalidationType=%v"
        $debugPrefix
        (jsonify (dict "indent" "  ") $style)
        (jsonify (dict "indent" "  ") $validStyles)
        (jsonify (dict "indent" "  ") $validationType) }}
  {{- end }}

  {{- $styleClass := slice }}

  {{- with $style }}
    {{- range $key, $value := . }}
      {{- $keyStylePath := append $key $stylePath }}

      {{- if eq (printf "%T" $value) "<nil>" }}
      {{- else if reflect.IsMap $value }}
        {{- $subParams := (dict
          "Template" $template
          "Style" $value
          "ValidStyles" (index $validStyles $key)
          "StylePath" $keyStylePath
          "InducedPath" $inducedPath
          "StyleClassPrefix" $styleClassPrefix
          "ValidationType" $validationType
          "Debug" $debug
        ) }}
        {{- if $debug }}
          {{- warnf "%vkey=%v: value for this key is a map: recursive call with subParams=%v"
              $debugPrefix $key (jsonify (dict "indent" "  ") $subParams) }}
        {{- end }}

        {{- with $styleClassSub := partial $template $subParams }}
          {{- $styleClass = append $styleClassSub $styleClass }}
        {{- end }}

      {{- else if reflect.IsSlice $value }}

        {{/* Given that this is a slice, we expect that all its elements are scalar */}}
        {{- range $value }}
          {{- if reflect.IsMap . }}
            {{- errorf "%vkey=%v: value for this key is a map: this should never happen"
                $debugPrefix $key -}}
          {{- else if reflect.IsSlice . }}
            {{- errorf "%vkey=%v: value for this key is a map: this should never happen"
                $debugPrefix $key -}}
          {{- else }}
            {{- $styleClass = append (printf "%s%s_%v" $styleClassPrefix (delimit $keyStylePath `_`) .) $styleClass }}
          {{- end }}
        {{- end }}

      {{- else }}

        {{/* Given that this is a scalar, we expect it to be validated against a map or a scalar */}}
        {{- $valueHandled := false }}

        {{- $validationSpec := index $validStyles $key }}
        {{- if $debug }}
          {{- warnf "%vkey=%v process value=%v [type=%T]: validationSpec=%v"
              $debugPrefix $key $value $value $validationSpec }}
        {{- end }}

        {{- if ne (printf "%T" $validationSpec) "<nil>" }}

          {{- if reflect.IsMap $validationSpec }}

            {{- $resultingValue := index $validationSpec (string $value) }}
            {{- if ne (printf "%T" $resultingValue) "<nil>" }}
              {{- $styleClass = append (printf "%s%s_%v" $styleClassPrefix (delimit $keyStylePath `_`) .) $styleClass }}
              {{- $valueHandled = true }}
              {{- if $debug }}
                {{- warnf "%vkey=%v validated against MAP: value=%v [type=%T] resultingValue=%v"
                    $debugPrefix $key $value $value $resultingValue }}
              {{- end }}
            {{- else }}
              {{- errorf "%vkey=%v: value=%v [type=%T] string='%s' not found in validationSpec=%v"
                  $debugPrefix $key $value $value (string $value) (jsonify (dict "indent" "  ") $validationSpec) -}}
            {{- end }}

          {{- else }}

            {{- $validationTypeSpec := index $validationType (string $validationSpec) }}

            {{- if $debug }}
              {{- warnf "%vkey=%v process value=%v [type=%T]: validationSpec=%v validationTypeSpec=%v"
                  $debugPrefix $key $value $value $validationSpec $validationTypeSpec }}
            {{- end }}

            {{- if ne (printf "%T" $validationTypeSpec) "<nil>" }}

              {{/* valueType indicates, how to deal with the value of the param */}}
              {{- $valueType := printf "%T" $value }}

              {{- if in $validationTypeSpec.valid_types $valueType }}
                {{- if eq $validationTypeSpec.class "boolean" }}
                  {{- $valueHandled = true }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v validated as BOOLEAN: value=%v [type=%T] vs. validationSpec=%v"
                        $debugPrefix $key $value $value $validationSpec }}
                  {{- end }}
                  {{- if $value }}
                    {{- $styleClass = append (printf "%s%s" $styleClassPrefix (delimit $keyStylePath `_`)) $styleClass }}
                  {{- end }}
                {{- else if eq $validationTypeSpec.class "value" }}
                  {{- $styleClass = append (printf "%s%s_%v" $styleClassPrefix (delimit $keyStylePath `_`) .) $styleClass }}
                  {{- $valueHandled = true }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v validated as VALUE: value=%v [type=%T] vs. validationSpec=%v"
                        $debugPrefix $key $value $value $validationSpec }}
                  {{- end }}
                {{- else if eq $validationTypeSpec.class "ignore" }}
                  {{- $valueHandled = true }}
                  {{- if $debug }}
                    {{- warnf "%vkey=%v validated as IGNORE: value=%v [type=%T] vs. validationSpec=%v"
                        $debugPrefix $key $value $value $validationSpec }}
                  {{- end }}
                {{- else }}
                  {{- errorf "%vkey=%v: value=%v [type=%T] unexpected validationTypeSpec.class=%v from validationTypeSpec=%v"
                      $debugPrefix $key $value $valueType $validationTypeSpec.class
                      (jsonify (dict "indent" "  ") $validationTypeSpec) -}}
                {{- end }}
              {{- else }}
                {{- errorf "%vkey=%v: value=%v with validationSpec=%v has wrong valueType=%v not found in valid_types=%v from validationTypeSpec=%v"
                    $debugPrefix $key $value $validationSpec $valueType $validationTypeSpec.valid_types
                    (jsonify (dict "indent" "  ") $validationTypeSpec) -}}
              {{- end }}
            {{- else }}

              {{/* There is no specific treatment given in validStyles, hence validationSpec
                   is interpreted as a validation value to compare against  */}}

              {{- $resultingValue := and (eq $validationSpec (string $value)) (string $value) }}

              {{- if $debug }}
                {{- warnf "%vkey=%v process value=%v [type=%T]: validationSpec=%v validationTypeSpec=%v resultingValue=%v"
                    $debugPrefix $key $value $value $validationSpec $validationTypeSpec $resultingValue }}
              {{- end }}

              {{- if ne (printf "%T" $validationSpec) "<nil>" }}
                {{- $styleClass = append (printf "%s%s_%v" $styleClassPrefix (delimit $keyStylePath `_`) $resultingValue) $styleClass }}
                {{- $valueHandled = true }}
                {{- if $debug }}
                  {{- warnf "%vkey=%v validated as VERBATIM value=%v [type=%T] vs. validationSpec=%v"
                      $debugPrefix $key $value $value $validationSpec }}
                {{- end }}
              {{- else }}
                {{- errorf "%vkey=%v: value=%v has unexpected type=%T"
                    $debugPrefix $key $value $value }}
              {{- end }}
            {{- end }}

            {{- if not $valueHandled }}
              {{- errorf "%vkey=%v: value=%v [type=%T] could not be parsed"
                  $debugPrefix $key $value $value }}
            {{- end }}

          {{- end }}
        {{- else }}
          {{- errorf "%vkey=%v: validationSpec=%v key not found in validStyles=%v"
              $debugPrefix $key $validationSpec
              (jsonify (dict "indent" "  ") $validStyles) -}}
        {{- end }}
      {{- end }}
    {{- end }}

  {{- end }}
  {{- return $styleClass }}
{{- end }}
